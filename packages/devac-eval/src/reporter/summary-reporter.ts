/**
 * Summary Reporter - generates human-readable reports from evaluation runs
 */

import {
  analyzeByQuestion,
  calculateImprovementScore,
  calculateWinRate,
  getBestImprovement,
  getRegressions,
  getTopImprovements,
  getWorstImprovement,
} from "../judge/metrics.js";
import type { EvalRun, RunSummary } from "../types.js";

export type ReportFormat = "markdown" | "json" | "table";

export interface SummaryReporterOptions {
  format: ReportFormat;
}

/**
 * Generate summary reports from evaluation runs
 */
export class SummaryReporter {
  private format: ReportFormat;

  constructor(options: SummaryReporterOptions) {
    this.format = options.format;
  }

  /**
   * Generate a summary report for a run
   */
  generate(run: EvalRun): string {
    if (!run.summary) {
      throw new Error("Run has no summary. Judge the run first.");
    }

    switch (this.format) {
      case "markdown":
        return this.generateMarkdown(run, run.summary);
      case "json":
        return this.generateJSON(run, run.summary);
      case "table":
        return this.generateTable(run, run.summary);
    }
  }

  /**
   * Generate markdown report
   */
  private generateMarkdown(run: EvalRun, summary: RunSummary): string {
    const winRate = calculateWinRate(summary);
    const improvementScore = calculateImprovementScore(summary);
    const bestDim = getBestImprovement(summary);
    const worstDim = getWorstImprovement(summary);

    const analysis = analyzeByQuestion(run.pointwiseScores, run.pairwiseResults);
    const topImprovements = getTopImprovements(analysis, 3);
    const regressions = getRegressions(analysis);

    let md = `# DevAC Evaluation Report

## Run Information
- **Run ID:** ${run.id}
- **Benchmark:** ${run.benchmarkId}
- **Started:** ${run.startedAt}
- **Status:** ${run.status}
- **Response Model:** ${run.config.responseModel}
- **Judge Model:** ${run.config.judgeModel}

## Overall Results

| Metric | Value |
|--------|-------|
| Total Questions | ${summary.totalQuestions} |
| Enhanced Wins | ${summary.enhancedWins} |
| Baseline Wins | ${summary.baselineWins} |
| Ties | ${summary.ties} |
| **Win Rate** | **${(winRate * 100).toFixed(1)}%** |
| **Improvement Score** | **${improvementScore > 0 ? "+" : ""}${improvementScore.toFixed(2)}** |

## Dimension Scores

### Average Scores by Mode

| Dimension | Baseline | Enhanced | Delta |
|-----------|----------|----------|-------|
| Correctness | ${summary.averageScores.baseline.correctness.toFixed(2)} | ${summary.averageScores.enhanced.correctness.toFixed(2)} | ${this.formatDelta(summary.deltas.correctness)} |
| Completeness | ${summary.averageScores.baseline.completeness.toFixed(2)} | ${summary.averageScores.enhanced.completeness.toFixed(2)} | ${this.formatDelta(summary.deltas.completeness)} |
| Hallucination | ${summary.averageScores.baseline.hallucination.toFixed(2)} | ${summary.averageScores.enhanced.hallucination.toFixed(2)} | ${this.formatDelta(summary.deltas.hallucination)} |
| Comprehensibility | ${summary.averageScores.baseline.comprehensibility.toFixed(2)} | ${summary.averageScores.enhanced.comprehensibility.toFixed(2)} | ${this.formatDelta(summary.deltas.comprehensibility)} |
| Context Usage | N/A | ${summary.averageScores.enhanced.contextUsage.toFixed(2)} | - |

### Key Insights

- **Best Improvement:** ${bestDim.dimension} (${this.formatDelta(bestDim.delta)})
- **Needs Attention:** ${worstDim.dimension} (${this.formatDelta(worstDim.delta)})

`;

    if (topImprovements.length > 0) {
      md += `## Top Improvements

Questions where DevAC tooling helped most:
${topImprovements.map((id) => `- ${id}`).join("\n")}

`;
    }

    if (regressions.length > 0) {
      md += `## Regressions

Questions where baseline performed better:
${regressions.map((id) => `- ${id}`).join("\n")}

`;
    }

    md += `---
*Generated by DevAC Eval Framework*
`;

    return md;
  }

  /**
   * Generate JSON report
   */
  private generateJSON(run: EvalRun, summary: RunSummary): string {
    const winRate = calculateWinRate(summary);
    const improvementScore = calculateImprovementScore(summary);
    const bestDim = getBestImprovement(summary);
    const worstDim = getWorstImprovement(summary);

    const analysis = analyzeByQuestion(run.pointwiseScores, run.pairwiseResults);
    const topImprovements = getTopImprovements(analysis, 5);
    const regressions = getRegressions(analysis);

    const report = {
      runId: run.id,
      benchmarkId: run.benchmarkId,
      startedAt: run.startedAt,
      completedAt: run.completedAt,
      status: run.status,
      config: run.config,
      summary,
      insights: {
        winRate,
        improvementScore,
        bestImprovement: bestDim,
        worstImprovement: worstDim,
        topImprovements,
        regressions,
      },
    };

    return JSON.stringify(report, null, 2);
  }

  /**
   * Generate ASCII table report
   */
  private generateTable(run: EvalRun, summary: RunSummary): string {
    const winRate = calculateWinRate(summary);

    const output = `
DevAC Evaluation Report
=======================

Run: ${run.id.slice(0, 8)}
Benchmark: ${run.benchmarkId}
Status: ${run.status}

Results
-------
Questions:  ${summary.totalQuestions}
Enhanced:   ${summary.enhancedWins} wins
Baseline:   ${summary.baselineWins} wins
Ties:       ${summary.ties}
Win Rate:   ${(winRate * 100).toFixed(1)}%

Dimension Scores
----------------
                 Baseline    Enhanced    Delta
Correctness      ${this.pad(summary.averageScores.baseline.correctness)}       ${this.pad(summary.averageScores.enhanced.correctness)}       ${this.padDelta(summary.deltas.correctness)}
Completeness     ${this.pad(summary.averageScores.baseline.completeness)}       ${this.pad(summary.averageScores.enhanced.completeness)}       ${this.padDelta(summary.deltas.completeness)}
Hallucination    ${this.pad(summary.averageScores.baseline.hallucination)}       ${this.pad(summary.averageScores.enhanced.hallucination)}       ${this.padDelta(summary.deltas.hallucination)}
Comprehensibility${this.pad(summary.averageScores.baseline.comprehensibility)}       ${this.pad(summary.averageScores.enhanced.comprehensibility)}       ${this.padDelta(summary.deltas.comprehensibility)}
Context Usage    N/A         ${this.pad(summary.averageScores.enhanced.contextUsage)}       -
`;

    return output;
  }

  /**
   * Format delta with + or - sign
   */
  private formatDelta(delta: number): string {
    const sign = delta > 0 ? "+" : "";
    return `${sign}${delta.toFixed(2)}`;
  }

  /**
   * Pad number for table alignment
   */
  private pad(n: number): string {
    return n.toFixed(2).padStart(5);
  }

  /**
   * Pad delta for table alignment
   */
  private padDelta(n: number): string {
    const sign = n > 0 ? "+" : "";
    return `${sign}${n.toFixed(2)}`.padStart(6);
  }
}
