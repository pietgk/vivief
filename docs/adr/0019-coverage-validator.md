# ADR-0019: Coverage Validator Integration

## Status

Accepted

## Context

DevAC Phase 2 provides validation diagnostics for type errors (tsc), lint issues (eslint), and test results. However, test coverage—a key metric for code quality—was not integrated into the diagnostics flow.

**Terminology note:** In DevAC's Four Pillars model (see [concepts.md](../vision/concepts.md)), **Validators** produce **Diagnostics**. Coverage is one such validator, producing diagnostics about untested code.

Coverage data has unique characteristics:
- Generated by running test suite with `--coverage` flag
- Produces per-file metrics (lines, branches, functions, statements)
- Identifies untested code that may contain bugs
- Correlates with CodeGraph: untested exports, unused code paths

We needed coverage as a first-class validation source to:
1. Surface untested files through MCP queries
2. Enrich coverage issues with caller/dependent context
3. Track coverage trends in the Hub
4. Enable "what needs tests?" queries for LLMs

## Decision

Add a **CoverageValidator** following the existing validator pattern (TypecheckValidator, LintValidator, TestValidator).

### CoverageValidator Interface

```typescript
export interface CoverageOptions {
  timeout?: number;              // Default: 120000ms
  thresholdLines?: number;       // Min % for lines (default: 0 = report all)
  thresholdBranches?: number;
  thresholdFunctions?: number;
  tool?: "vitest" | "jest" | "nyc";  // Auto-detected if not specified
}

export interface CoverageResult {
  success: boolean;              // All files above threshold
  issues: CoverageIssue[];       // Files below threshold
  timeMs: number;
  summary: CoverageSummary;      // Overall percentages
  files: FileCoverage[];         // Per-file metrics
  tool: string;
}
```

### Integration Points

1. **ValidationCoordinator**: Added `runCoverage` config option and `coverage` result field
2. **Hub Integration**: Coverage diagnostics pushed to `unified_diagnostics` with source `"coverage"` and category `"validation"`
3. **IssueEnricher**: Coverage diagnostics enriched with CodeGraph context (callers, dependents)
4. **CLI**: New `devac coverage` command

### Coverage Issue Format

For each file below threshold, a `CoverageIssue` is created:

```typescript
{
  file: "src/context/ci-hub-sync.ts",
  line: 1,
  column: 0,
  message: "Coverage: 0% lines, 0% branches, 0% functions (threshold: 50%)",
  severity: "warning",
  source: "coverage",
  code: "COVERAGE_BELOW_THRESHOLD"
}
```

### Vitest Config Updates

All package vitest configs updated with:
- Proper exclusions: `types.ts`, `index.ts`, `__tests__/**`
- `reportOnFailure: true` to always generate coverage data
- JSON reporter for parsing

```typescript
coverage: {
  provider: "v8",
  reporter: ["text", "json", "html"],
  include: ["src/**/*.ts"],
  exclude: [
    "src/**/*.d.ts",
    "src/**/index.ts",
    "src/**/types.ts",
    "src/**/__tests__/**",
  ],
  reportOnFailure: true,
},
```

### Alternatives Considered

1. **Native Vitest Thresholds**
   - ❌ Vitest 3.x has no "warn mode" (thresholds either pass or fail)
   - ❌ No integration with Hub or CodeGraph enrichment
   - ✅ Simpler configuration

2. **Separate Coverage Tool**
   - ❌ Extra dependency and configuration
   - ❌ Doesn't follow validator pattern
   - ✅ More specialized features

3. **CoverageValidator (chosen)**
   - ✅ Consistent with existing validator pattern
   - ✅ Integrates with Hub, CodeGraph enrichment
   - ✅ Configurable thresholds with warning mode
   - ✅ Supports vitest, jest, nyc

## Consequences

### Positive

- Coverage diagnostics visible via MCP tools (`get_all_diagnostics --source coverage`)
- CodeGraph enrichment shows callers/dependents for untested code
- Consistent threshold behavior across all packages
- LLMs can answer "what code needs tests?" queries
- CLI provides human-readable coverage reports

### Negative

- Coverage runs are slow (full test suite execution)
- Full mode validation takes longer with coverage enabled
- Additional Hub storage for coverage diagnostics

### Neutral

- Coverage diagnostics are warnings, don't fail overall validation
- Threshold of 0 reports all coverage data without failing
- Coverage can be run independently via `devac coverage`

## Implementation

**Files Created:**

| File | Description |
|------|-------------|
| `devac-core/src/validation/validators/coverage-validator.ts` | CoverageValidator implementation |
| `devac-cli/src/commands/coverage.ts` | CLI coverage command |
| `devac-core/__tests__/validation/validators/coverage-validator.test.ts` | Unit tests |

**Files Modified:**

| File | Changes |
|------|---------|
| `packages/*/vitest.config.ts` (4 files) | Added exclusions, `reportOnFailure` |
| `devac-core/src/validation/validators/index.ts` | Export CoverageValidator |
| `devac-core/src/validation/index.ts` | Export coverage types |
| `devac-core/src/index.ts` | Export from package root |
| `devac-core/src/validation/validation-coordinator.ts` | Added `runCoverage`, `coverage` result |
| `devac-core/src/validation/issue-enricher.ts` | Added "coverage" to source type |
| `devac-core/src/validation/hub-integration.ts` | Push coverage diagnostics to Hub |
| `devac-core/src/hub/hub-storage.ts` | Added "coverage" to DiagnosticSource |
| `devac-core/src/hub/central-hub.ts` | Handle coverage in pushDiagnostics |
| `devac-cli/src/commands/index.ts` | Export coverage command |
| `devac-cli/src/index.ts` | Register coverage command |

**New CLI Commands:**

| Command | Description |
|---------|-------------|
| `devac coverage` | Run coverage analysis |
| `devac coverage --threshold 50` | Report files below 50% |
| `devac coverage --pretty` | Human-readable output |

## Usage Examples

### CLI Usage

```bash
# Report all coverage
devac coverage -p packages/devac-core

# Files below 50% threshold
devac coverage --threshold 50 --pretty

# JSON output for automation
devac coverage --no-pretty
```

### MCP Query

```
get_all_diagnostics --source coverage
```

Returns:
```json
{
  "file": "src/context/ci-hub-sync.ts",
  "line": 1,
  "message": "Coverage: 0% lines (threshold: 50%)",
  "severity": "warning",
  "source": "coverage",
  "affectedSymbol": {
    "name": "syncCIStatusToHub",
    "kind": "function"
  },
  "callers": [
    { "name": "hubSyncCommand", "filePath": "src/commands/hub-sync.ts" }
  ]
}
```

### Enriched Output (LLM-Ready)

```markdown
## Validation Issue

**File:** `src/context/ci-hub-sync.ts` **Line:** 1

### Warning: Coverage: 0% lines (threshold: 50%)

**Code:** COVERAGE_BELOW_THRESHOLD

### Affected Symbol

`syncCIStatusToHub` (function)

### Called By (2)

- `hubSyncCommand` in `src/commands/hub-sync.ts`
- `contextCommand` in `src/commands/context.ts`

### Files That May Be Affected (2)

- `src/context/index.ts`
- `src/hub/central-hub.ts`
```

## References

- [DevAC Concepts](../vision/concepts.md) - Four Pillars, Diagnostics terminology
- [Validation & Diagnostics](../vision/validation.md) - Unified diagnostics vision
- [ADR-0017: Validation Hub Cache](0017-validation-hub-cache.md) - Diagnostics storage architecture
- [ADR-0018: Unified Diagnostics Model](0018-unified-diagnostics-model.md) - Unified diagnostics schema
- [Plan: Coverage Validator Integration](/.claude/plans/validated-honking-pine.md) - Implementation plan
